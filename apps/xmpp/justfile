# XMPP Service Justfile
# Profile-based Docker Compose orchestration

set export := true

# Start development environment (with dev tools)
[group('Development')]
up:
    docker compose --profile dev up -d
    @echo "Development environment started!"
    @echo "Adminer: http://localhost:8081"
    @echo "Logs:    http://localhost:8082"
    @echo "Web Client: http://localhost:8083"

# Start production environment (no dev tools)
[group('Production')]
up-prod:
    docker compose up -d
    @echo "Production environment started!"

# Stop all services
[group('Development')]
down:
    docker compose --profile dev down

# View logs
[group('Development')]
logs:
    docker compose --profile dev logs -f

# Build containers
[group('Development')]
build:
    docker compose --profile dev build --no-cache

# Clean environment (targeted)
[group('Development')]
clean:
    @echo "Performing targeted cleanup..."
    docker compose --profile dev down -v --remove-orphans
    @echo "Removing XMPP networks..."
    -docker network ls --filter "label=com.docker.compose.project=atl-xmpp" -q | xargs -r docker network rm
    @echo "Removing XMPP volumes..."
    -docker volume ls --filter "label=com.docker.compose.project=atl-xmpp" -q | xargs -r docker volume rm

# Open shell in running Prosody container
[group('Management')]
shell:
    @CONTAINER=$(docker compose ps -q atl-xmpp-server 2>/dev/null); \
    if [ -n "$CONTAINER" ]; then \
        docker exec -it $CONTAINER /bin/bash; \
    else \
        echo "XMPP server not running"; \
    fi

# Reload Prosody configuration
[group('Management')]
reload:
    @echo "Reloading Prosody configuration..."
    @CONTAINER=$(docker compose ps -q atl-xmpp-server 2>/dev/null); \
    if [ -n "$CONTAINER" ]; then \
        docker exec $CONTAINER prosodyctl reload; \
    else \
        echo "XMPP server not running"; \
    fi

# Add a user (usage: just xmpp adduser user@domain.com [password])
[group('User Management')]
adduser user password="":
    @echo "Adding user: $user"
    @CONTAINER=$(docker compose ps -q atl-xmpp-server 2>/dev/null); \
    if [ -n "$CONTAINER" ]; then \
        if [ -n "$password" ]; then \
            docker exec $CONTAINER bash -c "echo -e '$password\n$password' | prosodyctl adduser $user"; \
        else \
            docker exec -it $CONTAINER prosodyctl adduser $user; \
        fi; \
    else \
        echo "XMPP server not running"; \
    fi

# Delete a user (usage: just xmpp deluser user@domain.com)
[group('User Management')]
deluser user:
    @echo "Deleting user: $user"
    @CONTAINER=$(docker compose ps -q atl-xmpp-server 2>/dev/null); \
    if [ -n "$CONTAINER" ]; then \
        docker exec $CONTAINER prosodyctl deluser $user; \
    else \
        echo "XMPP server not running"; \
    fi

# Backup PostgreSQL database
[group('Database')]
db-backup:
    @echo "Backing up database..."
    @CONTAINER=$(docker compose ps -q atl-xmpp-db 2>/dev/null); \
    if [ -n "$CONTAINER" ]; then \
        BACKUP_FILE="backup_$(date +%Y%m%d_%H%M%S).sql"; \
        docker exec $CONTAINER pg_dumpall -U prosody > $BACKUP_FILE; \
        echo "Database backup saved to: $BACKUP_FILE"; \
    else \
        echo "Database not running"; \
    fi

# Setup Prosody community modules locally
[group('Modules')]
setup-modules:
    @echo "Setting up Prosody community modules locally..."
    ./scripts/setup-modules-locally.sh

# Update local Prosody community modules
[group('Modules')]
update-modules:
    @echo "Updating local Prosody community modules..."
    @if [[ -d "prosody-modules/.hg" ]]; then \
        (cd prosody-modules && (hg pull bundle 2>/dev/null || hg pull default) && hg update); \
        echo "Modules updated successfully"; \
    else \
        echo "prosody-modules repository not found. Run 'just xmpp-setup-modules' first"; \
    fi

# Check certificate status (usage: just xmpp check-cert domain)
[group('Certificates')]
check-cert domain:
    @echo "Checking certificate for: $domain"
    @CONTAINER=$(docker compose ps -q atl-xmpp-server 2>/dev/null); \
    if [ -n "$CONTAINER" ]; then \
        docker exec $CONTAINER /usr/local/bin/certificate-monitor.sh check "$domain"; \
    else \
        echo "XMPP server not running"; \
    fi
