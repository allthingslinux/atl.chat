# ============================================================================
# BUILD STAGE - Compile Atheme from source
# ============================================================================
FROM alpine:3.23@sha256:51183f2cfa6320055da30872f211093f9ff1d3cf06f39a0bdb212314c5dc7375 AS builder

# Build arguments - use master for 7.3 dev (no v7.3 tag yet); use v7.2.12 for stable
ARG ATHEME_VERSION="master"

# Install build dependencies
# hadolint ignore=DL3018
RUN apk add --no-cache \
    build-base \
    pkgconf \
    openssl-dev \
    libidn-dev \
    git \
    autoconf \
    automake \
    libtool \
    gettext-dev

# Download and build Atheme
WORKDIR /usr/src

# Clone Atheme source with submodules (tag includes correct submodule refs)
RUN git clone https://github.com/atheme/atheme -b "${ATHEME_VERSION}" --depth=1 atheme-src --recurse-submodules

# Configure, build, and install Atheme
WORKDIR /usr/src/atheme-src
RUN sed -i "s/@MKDIR_P@/mkdir -p/g" /usr/src/atheme-src/modules/contrib/buildsys.mk.in && \
    ./configure \
    --prefix=/usr/local/atheme \
    --enable-contrib \
    --with-modulesdir=/usr/local/atheme/modules \
    --with-libidn \
    --enable-large-net \
    --disable-linker-defs && \
    make -j"$(nproc)" && \
    make install

# ============================================================================
# RUNTIME STAGE - Minimal production container
# ============================================================================
FROM alpine:3.23@sha256:51183f2cfa6320055da30872f211093f9ff1d3cf06f39a0bdb212314c5dc7375

# Runtime arguments
ARG UID=1000
ARG GID=1000

LABEL org.opencontainers.image.source="https://github.com/allthingslinux/atl.chat" \
    org.opencontainers.image.description="Atheme IRC services for atl.chat" \
    org.opencontainers.image.licenses="MIT" \
    org.opencontainers.image.vendor="All Things Linux" \
    org.opencontainers.image.title="atl-atheme"

# Install runtime dependencies
# hadolint ignore=DL3018
RUN apk add --no-cache \
    openssl \
    libidn \
    ca-certificates \
    tini

# Create atheme user with specific UID/GID
RUN addgroup -g ${GID} -S atheme && \
    adduser -u ${UID} -D -S -G atheme atheme

# Copy built application from builder stage; set ownership in one step (no extra chown layer)
COPY --from=builder --chown=atheme:atheme /usr/local/atheme /usr/local/atheme

# Create runtime directories (not present in builder); chown only these new dirs
# etc=config (mounted), data=DB (mounted), var=PID file
# Logging goes to stdout (/dev/stdout) â€” no logs directory needed
RUN mkdir -p /usr/local/atheme/etc \
    /usr/local/atheme/data \
    /usr/local/atheme/var && \
    chown atheme:atheme /usr/local/atheme/etc /usr/local/atheme/data /usr/local/atheme/var

# Copy entrypoint script
COPY docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

# Set working directory
WORKDIR /usr/local/atheme

# Health check - verify Atheme services are running
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD pgrep -f atheme-services > /dev/null || exit 1

# Switch to atheme user for security
USER atheme

# Use tini as init system
# Entrypoint handles service startup
ENTRYPOINT ["/sbin/tini", "--", "/usr/local/bin/docker-entrypoint.sh"]
