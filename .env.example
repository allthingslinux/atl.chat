# Master Environment Registry - atl.chat Monorepo
# Copy to .env and customize. For dev (localhost): also copy .env.dev.example to .env.dev.
#
# 12-factor: Every variable here is consumed by at least one compose file,
# config template, script, or application. No orphans.
#
# Sections: Core → IRC → XMPP → Bridge → Web → Portal (external)

# =============================================================================
# CORE
# =============================================================================
ATL_ENVIRONMENT=dev        # dev, prod — controls TLS verify, log levels

# Docker UID/GID (solves volume permission issues)
PUID=1000
PGID=1000
TZ=UTC

# Host networking (Tailscale 100.64.0.0/10 for prod; 127.0.0.1 for dev via .env.dev)
ATL_GATEWAY_IP=100.64.1.0
ATL_CHAT_IP=100.64.7.0

# Let's Encrypt (cert-manager)
LETSENCRYPT_EMAIL=admin@allthingslinux.org
CLOUDFLARE_DNS_API_TOKEN=

# =============================================================================
# IRC SERVICE (UnrealIRCd + Atheme)
# =============================================================================
# Build versions (git tags)
UNREALIRCD_VERSION=6.2.0.1
ATHEME_VERSION=master

# --- Network identity ---
IRC_DOMAIN=irc.atl.chat
IRC_ROOT_DOMAIN=atl.chat
IRC_NETWORK_NAME="All Things Linux IRC"
IRC_CLOAK_PREFIX=atl

# --- Ports (mapped in compose) ---
IRC_TLS_PORT=6697
IRC_SERVER_PORT=6900
IRC_RPC_PORT=8600
IRC_WEBSOCKET_PORT=8000

# --- Security secrets (CHANGE THESE) ---
# Cloak keys — must be identical on all servers. Generate with: just irc gencloak
IRC_CLOAK_KEY_1=daa0ad2a69ba7683a2cdb02499f2e98b0729423bb7578d1f1dfbcdfe015f1f8b554b13203289c83D
IRC_CLOAK_KEY_2=899874eda706ee805bd34792bfd7bd62711f1938dea920c8bdf8396fe136ab6a83785a3ce54eB298
IRC_CLOAK_KEY_3=d8936d8fff38eace5c379c94578abfa802088bd241329c64506513fe8e4de3e2304f7dd00355A8d6
IRC_OPER_PASSWORD='$argon2id$v=19$m=6144,t=2,p=2$WXOLpTE+DPDr8q6OBVTx3w$bqXpBsaAK6lkXfR/IPn+TcE0VJEKjUFD7xordE6pFSo'
IRC_DRPASS=change_me_drpass
IRC_SERVICES_PASSWORD=change_me_secure_services_pass
ATL_WEBIRC_PASSWORD=change_me_webirc_password

# --- Admin info ---
IRC_ADMIN_NAME="All Things Linux"
IRC_ADMIN_EMAIL=admin@allthingslinux.org
IRC_STAFF_VHOST=allthingslinux.org

# --- STS (Strict Transport Security) ---
IRC_STS_DURATION=1m
IRC_STS_PRELOAD=no

# --- TLS cert paths (inside container) ---
IRC_SSL_CERT_PATH=/home/unrealircd/unrealircd/certs/live/irc.atl.chat/fullchain.pem
IRC_SSL_KEY_PATH=/home/unrealircd/unrealircd/certs/live/irc.atl.chat/privkey.pem

# --- Atheme services link ---
IRC_SERVICES_SERVER=services.atl.chat
ATHEME_SERVER_NAME=services.atl.chat
ATHEME_SERVER_DESC="All Things Linux IRC Services"
ATHEME_UPLINK_HOST=127.0.0.1
ATHEME_UPLINK_PORT=6901
ATHEME_NUMERIC=00A
ATHEME_RECONTIME=10
ATHEME_HTTPD_PORT=8081

# --- Atheme network info ---
ATHEME_NETNAME=atl.chat
ATHEME_ADMIN_NAME="All Things Linux"
ATHEME_ADMIN_EMAIL=admin@allthingslinux.org
ATHEME_REGISTER_EMAIL=noreply@allthingslinux.org
ATHEME_HIDEHOST_SUFFIX=users.atl.chat
ATHEME_HELP_CHANNEL=#help
ATHEME_HELP_URL=https://discord.gg/linux

# --- Atheme service bot identities ---
# Format: ATHEME_<SERVICE>_NICK, _USER, _HOST, _REAL
ATHEME_NICKSERV_NICK=NickServ
ATHEME_NICKSERV_USER=NickServ
ATHEME_NICKSERV_HOST=services.atl.chat
ATHEME_NICKSERV_REAL="Nickname Services"

ATHEME_CHANSERV_NICK=ChanServ
ATHEME_CHANSERV_USER=ChanServ
ATHEME_CHANSERV_HOST=services.atl.chat
ATHEME_CHANSERV_REAL="Channel Services"

ATHEME_OPERSERV_NICK=OperServ
ATHEME_OPERSERV_USER=OperServ
ATHEME_OPERSERV_HOST=services.atl.chat
ATHEME_OPERSERV_REAL="Operator Services"

ATHEME_MEMOSERV_NICK=MemoServ
ATHEME_MEMOSERV_USER=MemoServ
ATHEME_MEMOSERV_HOST=services.atl.chat
ATHEME_MEMOSERV_REAL="Memo Services"

ATHEME_SASLSERV_NICK=SaslServ
ATHEME_SASLSERV_USER=SaslServ
ATHEME_SASLSERV_HOST=services.atl.chat
ATHEME_SASLSERV_REAL="SASL Authentication Agent"

ATHEME_BOTSERV_NICK=BotServ
ATHEME_BOTSERV_USER=BotServ
ATHEME_BOTSERV_HOST=services.atl.chat
ATHEME_BOTSERV_REAL="Bot Services"

ATHEME_GROUPSERV_NICK=GroupServ
ATHEME_GROUPSERV_USER=GroupServ
ATHEME_GROUPSERV_HOST=services.atl.chat
ATHEME_GROUPSERV_REAL="Group Management Services"

ATHEME_HOSTSERV_NICK=HostServ
ATHEME_HOSTSERV_USER=HostServ
ATHEME_HOSTSERV_HOST=services.atl.chat
ATHEME_HOSTSERV_REAL="Host Management Services"

ATHEME_INFOSERV_NICK=InfoServ
ATHEME_INFOSERV_USER=InfoServ
ATHEME_INFOSERV_HOST=services.atl.chat
ATHEME_INFOSERV_REAL="Information Service"

ATHEME_HELPSERV_NICK=HelpServ
ATHEME_HELPSERV_USER=HelpServ
ATHEME_HELPSERV_HOST=services.atl.chat
ATHEME_HELPSERV_REAL="Help Services"

ATHEME_STATSERV_NICK=StatServ
ATHEME_STATSERV_USER=StatServ
ATHEME_STATSERV_HOST=services.atl.chat
ATHEME_STATSERV_REAL="Statistics Services"

ATHEME_GLOBAL_NICK=Global
ATHEME_GLOBAL_USER=Global
ATHEME_GLOBAL_HOST=services.atl.chat
ATHEME_GLOBAL_REAL="Network Announcements"

ATHEME_ALIS_NICK=ALIS
ATHEME_ALIS_USER=alis
ATHEME_ALIS_HOST=services.atl.chat
ATHEME_ALIS_REAL="Channel Directory"

ATHEME_PROXYSCAN_NICK=Proxyscan
ATHEME_PROXYSCAN_USER=dnsbl
ATHEME_PROXYSCAN_HOST=services.atl.chat
ATHEME_PROXYSCAN_REAL="Proxyscan Service"

ATHEME_GAMESERV_NICK=GameServ
ATHEME_GAMESERV_USER=GameServ
ATHEME_GAMESERV_HOST=services.atl.chat
ATHEME_GAMESERV_REAL="Game Services"

ATHEME_RPGSERV_NICK=RPGServ
ATHEME_RPGSERV_USER=RPGServ
ATHEME_RPGSERV_HOST=services.atl.chat
ATHEME_RPGSERV_REAL="RPG Finding Services"

# --- WebPanel ---
WEBPANEL_PORT=8080
WEBPANEL_RPC_USER=adminpanel
WEBPANEL_RPC_PASSWORD=change_me_webpanel_password

# --- The Lounge ---
THELOUNGE_PORT=9000
THELOUNGE_WEBIRC_PASSWORD=change_me_thelounge_webirc
THELOUNGE_DELETE_UPLOADS_AFTER_MINUTES=1440

# =============================================================================
# XMPP SERVICE (Prosody)
# =============================================================================
XMPP_DOMAIN=atl.chat
PROSODY_ADMIN_EMAIL=admin@allthingslinux.org

# --- Storage (sqlite for dev, sql for prod with PROSODY_DB_* vars) ---
PROSODY_STORAGE=sqlite

# --- Database (only used when PROSODY_STORAGE=sql) ---
PROSODY_DB_DRIVER=PostgreSQL
PROSODY_DB_HOST=xmpp-postgres-dev
PROSODY_DB_PORT=5432
PROSODY_DB_NAME=prosody
PROSODY_DB_USER=prosody
PROSODY_DB_PASSWORD=change_me_secure_db_pass

# --- Ports (mapped in compose as PROSODY_*_PORT) ---
# Compose uses PROSODY_C2S_PORT (not XMPP_C2S_PORT) — keep names aligned.
PROSODY_C2S_PORT=5222
PROSODY_S2S_PORT=5269
PROSODY_HTTP_PORT=5280
PROSODY_HTTPS_PORT=5281
PROSODY_C2S_DIRECT_TLS_PORT=5223
PROSODY_S2S_DIRECT_TLS_PORT=5270
PROSODY_PROXY65_PORT=5000

# --- TURN/STUN ---
TURN_PORT=3478
TURNS_PORT=5349
TURN_SECRET=change_me_turn_secret
TURN_EXTERNAL_HOST=turn.atl.network

# --- Security ---
PROSODY_OAUTH2_REGISTRATION_KEY=change_me_secure_oauth2_key
PROSODY_ALLOW_REGISTRATION=false
PROSODY_C2S_REQUIRE_ENCRYPTION=true
PROSODY_S2S_REQUIRE_ENCRYPTION=true
PROSODY_S2S_SECURE_AUTH=true
PROSODY_ALLOW_UNENCRYPTED_PLAIN_AUTH=false
PROSODY_MAX_CONNECTIONS_PER_IP=10
PROSODY_REGISTRATION_THROTTLE_MAX=10
PROSODY_REGISTRATION_THROTTLE_PERIOD=60
PROSODY_BLOCK_REGISTRATIONS_REQUIRE=^[a-zA-Z0-9_.-]+$
PROSODY_TLS_CHANNEL_BINDING=false

# --- HTTP ---
PROSODY_HTTP_HOST=localhost
PROSODY_HTTP_SCHEME=http
PROSODY_UPLOAD_EXTERNAL_URL=http://localhost:5280/upload/
PROSODY_PROXY_ADDRESS=localhost

# --- TLS certs (path relative to Prosody cert dir; must match XMPP_DOMAIN) ---
# For dev: .env.dev overrides to certs/live/xmpp.localhost/...
# Leave these empty to fallback to default paths derived from XMPP_DOMAIN
# PROSODY_SSL_KEY=certs/live/atl.chat/privkey.pem
# PROSODY_SSL_CERT=certs/live/atl.chat/fullchain.pem

# --- Logging ---
PROSODY_LOG_LEVEL=info
PROSODY_STATISTICS=internal
PROSODY_STATISTICS_INTERVAL=manual
PROSODY_OPENMETRICS_IP=127.0.0.1
PROSODY_OPENMETRICS_CIDR=127.0.0.1/32

# --- MAM (Message Archiving) ---
PROSODY_ARCHIVE_EXPIRES_AFTER=30d
PROSODY_ARCHIVE_POLICY=true
PROSODY_ARCHIVE_COMPRESSION=true
PROSODY_ARCHIVE_STORE=archive
PROSODY_ARCHIVE_MAX_QUERY_RESULTS=250
PROSODY_MAM_SMART_ENABLE=true

# --- MUC ---
PROSODY_MUC_NOTIFICATIONS=true
PROSODY_MUC_OFFLINE_DELIVERY=true
PROSODY_RESTRICT_ROOM_CREATION=false
PROSODY_MUC_DEFAULT_PUBLIC=true
PROSODY_MUC_DEFAULT_PERSISTENT=true
PROSODY_MUC_DEFAULT_PUBLIC_JIDS=true
PROSODY_MUC_LOCKING=false
PROSODY_MUC_LOG_BY_DEFAULT=true
PROSODY_MUC_LOG_EXPIRES_AFTER=1y
PROSODY_MUC_LOG_PRESENCES=false
PROSODY_MUC_LOG_ALL_ROOMS=false
PROSODY_MUC_LOG_CLEANUP_INTERVAL=86400
PROSODY_MUC_MAX_ARCHIVE_QUERY_RESULTS=100
PROSODY_MUC_LOG_STORE=muc_log
PROSODY_MUC_LOG_COMPRESSION=true
PROSODY_MUC_MAM_SMART_ENABLE=false

# --- Rate limiting ---
PROSODY_C2S_RATE=10kb/s
PROSODY_C2S_BURST=25kb
PROSODY_C2S_STANZA_SIZE=262144
PROSODY_S2S_RATE=30kb/s
PROSODY_S2S_BURST=100kb
PROSODY_S2S_STANZA_SIZE=524288
PROSODY_HTTP_UPLOAD_RATE=2mb/s
PROSODY_HTTP_UPLOAD_BURST=10mb

# --- Push notifications ---
PROSODY_PUSH_IMPORTANT_BODY="New Message!"
PROSODY_PUSH_MAX_ERRORS=16
PROSODY_PUSH_MAX_DEVICES=5
PROSODY_PUSH_MAX_HIBERNATION_TIMEOUT=259200
PROSODY_PUSH_NOTIFICATION_WITH_BODY=false
PROSODY_PUSH_NOTIFICATION_WITH_SENDER=false

# --- Account lifecycle ---
PROSODY_ACCOUNT_INACTIVE_PERIOD=31536000
PROSODY_ACCOUNT_GRACE_PERIOD=2592000

# --- Server info ---
PROSODY_SERVER_NAME=localhost
PROSODY_SERVER_WEBSITE=http://localhost
PROSODY_SERVER_DESCRIPTION="XMPP Service"

# --- Performance tuning ---
LUA_GC_STEP_SIZE=13
LUA_GC_PAUSE=110
LUA_GC_SPEED=200
LUA_GC_THRESHOLD=120

# --- PubSub feeds ---
PROSODY_FEED_URL=https://allthingslinux.org/feed

# =============================================================================
# BRIDGE SERVICE (Discord↔IRC↔XMPP relay)
# =============================================================================
BRIDGE_DISCORD_TOKEN=change_me_discord_bot_token
BRIDGE_DISCORD_CHANNEL_ID=REPLACE_WITH_DISCORD_CHANNEL_ID
BRIDGE_PORTAL_BASE_URL=https://portal.atl.tools
BRIDGE_PORTAL_TOKEN=change_me_bridge_portal_token

# XMPP component
BRIDGE_XMPP_COMPONENT_JID=bridge.atl.chat
BRIDGE_XMPP_COMPONENT_SECRET=change_me_xmpp_component_secret
BRIDGE_XMPP_COMPONENT_SERVER=atl-xmpp-server
BRIDGE_XMPP_COMPONENT_PORT=5347

# IRC
BRIDGE_IRC_NICK=bridge
BRIDGE_IRC_OPER_PASSWORD=change_me_bridge_oper
IRC_BRIDGE_SERVER=atl-irc-server
# LOG_LEVEL=DEBUG

# =============================================================================
# WEB FRONTEND (Next.js)
# =============================================================================
NEXT_PUBLIC_IRC_WS_URL=wss://irc.atl.chat/ws
NEXT_PUBLIC_XMPP_BOSH_URL=https://xmpp.atl.chat/http-bind

# =============================================================================
# PORTAL INTEGRATION (consumed by external portal service, not this monorepo)
# =============================================================================
# These vars are pre-defined for the external ATL Portal service that connects
# to IRC/XMPP services. They are NOT consumed by any compose/config in this repo.
IRC_ATHEME_JSONRPC_URL=http://atl-irc-server:8081/jsonrpc
IRC_UNREAL_JSONRPC_URL=https://irc.atl.chat:8600/api
IRC_UNREAL_RPC_USER=adminpanel
IRC_UNREAL_RPC_PASSWORD=change_me_webpanel_password
PROSODY_REST_URL=http://atl-xmpp-server:5280
PROSODY_REST_USERNAME=admin@atl.chat
PROSODY_REST_PASSWORD=change_me_prosody_rest_password
IRC_SERVER=irc.atl.chat
IRC_PORT=6697
