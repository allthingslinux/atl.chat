# ============================================================================
# BUILD STAGE - Compile UnrealIRCd from source
# ============================================================================
# This stage compiles UnrealIRCd and preserves the source code for module management
FROM alpine:3.23@sha256:51183f2cfa6320055da30872f211093f9ff1d3cf06f39a0bdb212314c5dc7375 AS builder

# Build arguments
ARG UNREALIRCD_VERSION=6.2.0.1
ARG UID=0
ARG GID=0

# Install build dependencies
# hadolint ignore=DL3018
RUN apk update && apk add --no-cache \
    build-base \
    wget \
    pkgconfig \
    openssl \
    openssl-dev \
    pcre2-dev \
    c-ares-dev \
    curl-dev \
    argon2-dev \
    libsodium-dev \
    jansson-dev \
    cmake \
    file

# Create unrealircd user (skip if UID is 0)
RUN if [ "${UID}" != "0" ]; then \
    addgroup -g ${GID} unrealircd && \
    adduser -D -u ${UID} -G unrealircd -s /bin/false unrealircd; \
    fi

# Create installation directory
RUN mkdir -p /home/unrealircd/unrealircd

# Download and extract UnrealIRCd source
WORKDIR /tmp
RUN wget --progress=dot:giga https://www.unrealircd.org/downloads/unrealircd-${UNREALIRCD_VERSION}.tar.gz && \
    tar xzf unrealircd-${UNREALIRCD_VERSION}.tar.gz

# Create build user (UnrealIRCd refuses to build as root)
RUN addgroup -g 1001 builduser && \
    adduser -D -u 1001 -G builduser builduser && \
    mkdir -p /home/unrealircd && \
    chown -R builduser:builduser /tmp/unrealircd-${UNREALIRCD_VERSION} /home/unrealircd

# Switch to build user and configure
WORKDIR /tmp/unrealircd-${UNREALIRCD_VERSION}
USER builduser

# Copy configuration settings
COPY config.settings .

# Add atl.chat relaymsg fork as third/relaymsg-atl (unique name avoids upstream overwrite during make)
# UnrealIRCd's make runs "unrealircd -m upgrade" which replaces third/relaymsg with contrib version
COPY contrib/relaymsg/relaymsg-atl.c src/modules/third/

# Configure UnrealIRCd build
RUN ./Config -quick

# Compile UnrealIRCd (includes third/relaymsg-atl)
RUN make -j"$(nproc)"

# Install UnrealIRCd
RUN make install

# Install third-party modules specified in the manifest
COPY third-party-modules.list /home/unrealircd/third-party-modules.list
RUN while IFS= read -r module || [ -n "$module" ]; do \
    case "$module" in \
    \#*) continue ;; \
    "") continue ;; \
    esac; \
    echo "Installing module: $module"; \
    /home/unrealircd/unrealircd/unrealircd module install "$module" || exit 1; \
    done < /home/unrealircd/third-party-modules.list

# ============================================================================
# RUNTIME STAGE - Minimal production container (no build tools)
# ============================================================================
# Third-party modules are built in builder stage. To add modules, rebuild image.
FROM alpine:3.23@sha256:51183f2cfa6320055da30872f211093f9ff1d3cf06f39a0bdb212314c5dc7375

# Runtime arguments (inherit from builder stage)
ARG UID=0
ARG GID=0

# Install runtime dependencies only (no build toolchain)
# hadolint ignore=DL3018
RUN apk update && apk add --no-cache \
    openssl \
    pcre2 \
    c-ares \
    curl \
    ca-certificates \
    ca-certificates-bundle \
    tini \
    su-exec \
    netcat-openbsd \
    argon2-libs \
    libsodium \
    jansson

# Create unrealircd user with specific UID/GID
RUN if [ "${UID}" = "0" ]; then \
    addgroup -g 1000 unrealircd && \
    adduser -D -u 1000 -G unrealircd -s /bin/false unrealircd; \
    else \
    addgroup -g ${GID} unrealircd && \
    adduser -D -u ${UID} -G unrealircd -s /bin/false unrealircd; \
    fi

# Copy built application from builder (includes pre-compiled third-party modules)
COPY --from=builder /home/unrealircd/unrealircd /home/unrealircd/unrealircd

# Set ownership based on UID/GID arguments
RUN if [ "${UID}" = "0" ]; then \
    chown -R 1000:1000 /home/unrealircd/unrealircd; \
    else \
    chown -R ${UID}:${GID} /home/unrealircd/unrealircd; \
    fi

# Create directory structure with proper permissions
RUN mkdir -p /home/unrealircd/unrealircd/config \
    /home/unrealircd/unrealircd/logs \
    /home/unrealircd/unrealircd/data \
    /home/unrealircd/unrealircd/cache \
    /home/unrealircd/unrealircd/tmp \
    /run/unrealircd && \
    if [ "${UID}" = "0" ]; then \
    chown -R 1000:1000 /home/unrealircd/unrealircd && \
    chown -R 1000:1000 /run/unrealircd; \
    else \
    chown -R ${UID}:${GID} /home/unrealircd/unrealircd && \
    chown -R ${UID}:${GID} /run/unrealircd; \
    fi && \
    chmod -R 755 /home/unrealircd/unrealircd && \
    chmod 755 /run/unrealircd

# Copy entrypoint and utility scripts
COPY docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh
COPY ./scripts/module-config.sh /usr/local/bin/module-config.sh
COPY ./scripts/manage-modules.sh /usr/local/bin/manage-modules.sh
RUN chmod +x /usr/local/bin/docker-entrypoint.sh /usr/local/bin/module-config.sh /usr/local/bin/manage-modules.sh

# Set working directory
WORKDIR /home/unrealircd/unrealircd

# Expose IRC ports (TLS only)
EXPOSE 6697 6900 6901 8600 8000

# Health check - verify UnrealIRCd is responding via JSON-RPC (stronger than TCP only)
# Uses rpc.info over Unix socket; socket created by rpc.modules.default.conf
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD ["sh", "-c", "echo '{\"jsonrpc\":\"2.0\",\"method\":\"rpc.info\",\"params\":{},\"id\":1}' | nc -U /home/unrealircd/unrealircd/data/rpc.socket 2>/dev/null | grep -q '\"result\"' || exit 1"]

# Switch to unrealircd user for security
USER unrealircd

# Use tini as init system with child subreaper
# Entrypoint handles permissions and user switching
ENTRYPOINT ["/sbin/tini", "-s", "--", "/usr/local/bin/docker-entrypoint.sh"]
CMD ["start"]
