---
name: atl-irc

include:
  - ../../infra/docker/compose/networks.yaml

services:
  # ============================================================================
  # UNREALIRCD - Main IRC Server
  # ============================================================================
  atl-irc-server:
    build:
      context: ./services/unrealircd
      dockerfile: Containerfile
      args:
        UNREALIRCD_VERSION: ${UNREALIRCD_VERSION:-6.2.0.1}
        UID: ${PUID:-1000}
        GID: ${PGID:-1000}

    container_name: atl-irc-server
    hostname: atl-irc-server
    init: true
    restart: unless-stopped

    volumes:
      - ./services/unrealircd/conf:/home/unrealircd/unrealircd/conf
      - ../../data/irc/data:/home/unrealircd/unrealircd/data
      - ../../data/irc/logs:/home/unrealircd/unrealircd/logs
      - ../../data/certs:/home/unrealircd/unrealircd/conf/tls:ro

    env_file:
      - path: ../../.env
        required: false

    environment:
      - IRC_DOMAIN=${IRC_DOMAIN}
      - IRC_SSL_CERT_PATH=${IRC_SSL_CERT_PATH}
      - IRC_SSL_KEY_PATH=${IRC_SSL_KEY_PATH}
      - TZ=UTC
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}

    # Port mappings
    # Binding to 0.0.0.0 (or specific Host IP) so NPM upstream can reach us
    # NPM sends PROXY protocol headers, so UnrealIRCd must be configured with 'proxy' block
    ports:
      - '${IRC_TLS_PORT:-6697}:6697' # IRC over SSL/TLS (+ Proxy Protocol allowed)
      - '${IRC_SERVER_PORT:-6900}:6900' # Server-to-server TLS
      - '${ATHEME_UPLINK_PORT:-6901}:6901' # Atheme connection (internal)
      - '${IRC_RPC_PORT:-8600}:8600' # JSON-RPC API
      - '${IRC_WEBSOCKET_PORT:-8000}:8000' # WebSocket (for Webclient)

    networks:
      - atl-chat

    healthcheck:
      test: [ 'CMD', 'nc', '-z', 'localhost', '6697' ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================================================
  # ATHEME - IRC Services
  # ============================================================================
  atl-irc-services:
    build:
      context: ./services/atheme
      dockerfile: Containerfile
      args:
        UID: ${PUID:-1000}
        GID: ${PGID:-1000}

    container_name: atl-irc-services
    restart: unless-stopped

    depends_on:
      atl-irc-server:
        condition: service_healthy

    # Share network stack with IRC server for localhost uplink
    network_mode: service:atl-irc-server

    volumes:
      - ./services/atheme/config:/usr/local/atheme/etc
      - ../../data/atheme/data:/usr/local/atheme/data
      - ../../data/atheme/logs:/usr/local/atheme/logs

    environment:
      - TZ=UTC
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}

    healthcheck:
      test: [ 'CMD', 'pgrep', '-f', 'atheme-services' ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================================================
  # UNREALIRCD WEBPANEL
  # ============================================================================
  atl-irc-webpanel:
    build:
      context: .
      dockerfile: services/webpanel/Containerfile

    container_name: atl-irc-webpanel
    hostname: atl-irc-webpanel
    restart: unless-stopped

    depends_on:
      atl-irc-server:
        condition: service_healthy

    volumes:
      - ../../data/irc/webpanel-data:/var/www/html/unrealircd-webpanel/data

    env_file:
      - ../../.env

    environment:
      - TZ=UTC

    ports:
      - '${WEBPANEL_PORT:-8080}:8080'

    networks:
      - atl-chat
