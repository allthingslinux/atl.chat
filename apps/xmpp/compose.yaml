---
name: atl-xmpp

# Include shared infrastructure
include:
  - ../../infra/docker/compose/networks.yaml

services:
  # ==========================================================================
  # PROSODY XMPP SERVER
  # ==========================================================================
  atl-xmpp-server:
    build:
      context: ./services/prosody
      dockerfile: Containerfile
    image: allthingslinux/prosody:latest
    container_name: atl-xmpp-server
    hostname: atl-xmpp-server
    restart: unless-stopped
    init: true

    # Environment configuration
    env_file:
      - path: ../../.env
        required: false

    environment:
      - PROSODY_DOMAIN=${PROSODY_DOMAIN}
      - PROSODY_UPLOAD_EXTERNAL_URL=${PROSODY_UPLOAD_EXTERNAL_URL}
      - PROSODY_PROXY_ADDRESS=${PROSODY_PROXY_ADDRESS}
      # Allow overriding cert paths if needed (though existing defaults might work if files line up)
      # But to be safe and consistent with IRC:
      - PROSODY_SSL_KEY=${PROSODY_SSL_KEY}
      - PROSODY_SSL_CERT=${PROSODY_SSL_CERT}

    # Security
    security_opt:
      - no-new-privileges:true
      - apparmor:docker-default

    # Logging
    logging:
      driver: json-file
      options:
        max-size: "${LOG_MAX_SIZE:-50m}"
        max-file: "${LOG_MAX_FILES:-5}"
        compress: "true"

    # Port mappings
    # Exposed to Host for upstream NPM (Tailscale) access
    # Requires mod_net_proxy enabled in Prosody to handle PROXY protocol from NPM
    ports:
      - "${PROSODY_C2S_PORT:-5222}:5222" # XMPP client (TCP+ProxyProtocol)
      - "${PROSODY_S2S_PORT:-5269}:5269" # XMPP server (TCP+ProxyProtocol)
      - "${PROSODY_C2S_DIRECT_TLS_PORT:-5223}:5223" # XMPP client TLS (TCP+ProxyProtocol)
      - "${PROSODY_S2S_DIRECT_TLS_PORT:-5270}:5270" # XMPP server TLS (TCP+ProxyProtocol)
      - "${PROSODY_HTTP_PORT:-5280}:5280" # HTTP/BOSH (Proxied by NPM)
      - "${PROSODY_HTTPS_PORT:-5281}:5281" # HTTPS/BOSH (Proxied by NPM)
      - "${PROSODY_PROXY65_PORT:-5000}:5000" # Proxy65 file transfers

    # Volume mounts
    volumes:
      - ./services/prosody/config:/etc/prosody/config:ro
      - ./services/prosody/scripts:/opt/prosody/scripts:ro
      - ./web/assets:/usr/share/prosody/www:ro
      - ../../data/xmpp/data:/var/lib/prosody/data
      - ../../data/xmpp/uploads:/var/lib/prosody/uploads
      - ../../data/certs:/etc/prosody/certs

    healthcheck:
      test: [ "CMD", "/usr/local/bin/health-check.sh" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    depends_on:
      atl-xmpp-db:
        condition: service_healthy

    networks:
      - atl-chat

  # ==========================================================================
  # POSTGRESQL DATABASE
  # ==========================================================================
  atl-xmpp-db:
    image: postgres:17-alpine
    container_name: atl-xmpp-db
    hostname: atl-xmpp-db
    restart: unless-stopped

    env_file:
      - path: ../../.env
        required: false

    environment:
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C

    volumes:
      - ../../data/postgres:/var/lib/postgresql/data
      - ./services/prosody/database/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro

    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-prosody}" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    networks:
      - atl-chat
