# IRC Service Justfile
# Component-specific utilities
# Use root 'just' for lifecycle management (up, down, logs)

# Open shell in running IRCd container (uses root compose)
[group('Development')]
shell:
    @echo "Development Shell"
    docker compose -f ../../compose.yaml -p atl-chat exec atl-irc-server bash

# Run comprehensive test suite
[group('Testing')]
test:
    @echo "Running Comprehensive Tests"
    @echo "Running test suite with uv..."
    @uv run pytest tests/
    @echo "Test suite completed!"

# Run environment validation tests
[group('Testing')]
test-env:
    @echo "Environment Validation Tests"
    @uv run pytest tests/unit/test_environment_validation.py tests/unit/test_docker_client.py -v

# Run IRC functionality tests
[group('Testing')]
test-irc:
    @echo "IRC Functionality Tests"
    @uv run pytest tests/integration/test_irc_functionality.py tests/integration/test_protocol.py -v

# Run unit tests
[group('Testing')]
test-unit:
    @echo "Unit Tests"
    @uv run pytest tests/unit/ -v

# Run integration tests
[group('Testing')]
test-integration:
    @echo "Integration Tests"
    @uv run pytest tests/integration/ -v

# Run end-to-end tests
[group('Testing')]
test-e2e:
    @echo "End-to-End Tests"
    @uv run pytest tests/e2e/ -v

# Run protocol tests
[group('Testing')]
test-protocol:
    @echo "Protocol Tests"
    @uv run pytest tests/protocol/ -v

# Run performance tests
[group('Testing')]
test-performance:
    @echo "Performance Tests"
    @uv run pytest -m performance -v

# Run service tests
[group('Testing')]
test-services:
    @echo "Service Tests"
    @uv run pytest -m atheme -v

# Run docker tests
[group('Testing')]
test-docker:
    @echo "Docker-related Tests"
    @uv run pytest -m docker -v

# Quick environment check
[group('Testing')]
test-quick:
    @echo "Quick Environment Check"
    docker compose config --quiet
    @if docker compose ps | grep -q "Up"; then \
        echo "Services are running!"; \
    else \
        echo "No services are currently running."; \
    fi

# List available modules
[group('Modules')]
modules-list:
    @echo "Available Modules"
    docker compose exec atl-irc-server manage-modules.sh list

# List installed modules
[group('Modules')]
modules-installed:
    @echo "Installed Modules"
    docker compose exec atl-irc-server manage-modules.sh installed

# Start cert-manager (Lego) for Let's Encrypt certs. Requires CLOUDFLARE_DNS_API_TOKEN in .env.
[group('SSL')]
ssl-setup:
    @echo "Starting cert-manager (Lego)..."
    docker compose -f ../../compose.yaml --env-file ../../.env up -d cert-manager
    @echo "Cert-manager started. Certs will appear in data/certs/certificates/"

# Check SSL certificate status (cert-manager or dev certs)
[group('SSL')]
ssl-status:
    @echo "SSL Certificate Status"
    @if [[ -d "../../data/certs/certificates" ]] && ls ../../data/certs/certificates/*.crt 1>/dev/null 2>&1; then \
        echo "Cert-manager certs found:"; \
        ls -la ../../data/certs/certificates/*.crt 2>/dev/null || true; \
        docker compose -f ../../compose.yaml ps cert-manager 2>/dev/null | grep -q "Up" && echo "Cert-manager is running" || echo "Cert-manager not running"; \
    elif [[ -f "services/unrealircd/config/tls/server.cert.pem" ]]; then \
        echo "Dev certs found (init.sh)"; \
        openssl x509 -in services/unrealircd/config/tls/server.cert.pem -noout -dates 2>/dev/null || true; \
    else \
        echo "No SSL certificates found. Run 'just irc ssl-setup' for Let's Encrypt or 'just init' for dev certs."; \
    fi

# Cert-manager renews automatically every 24h. This restarts it to trigger a check.
[group('SSL')]
ssl-renew:
    @echo "Restarting cert-manager to trigger renewal check..."
    docker compose -f ../../compose.yaml restart cert-manager
    @echo "Cert-manager restarted."

# View cert-manager logs
[group('SSL')]
ssl-logs:
    @echo "Cert-manager Logs"
    docker compose -f ../../compose.yaml logs -f --tail=50 cert-manager

# Stop cert-manager
[group('SSL')]
ssl-stop:
    @echo "Stopping cert-manager"
    docker compose -f ../../compose.yaml stop cert-manager
    @echo "Cert-manager stopped."

# Remove SSL certificates (cert-manager output and dev certs)
[group('SSL')]
ssl-clean:
    @echo "WARNING: This will DELETE your SSL certificates!"
    @echo "This action cannot be undone."
    @read -p "Are you sure you want to continue? (type 'yes' to confirm): " confirm && \
    if [[ "$confirm" == "yes" ]]; then \
        echo "Removing SSL certificates..."; \
        docker compose -f ../../compose.yaml stop cert-manager 2>/dev/null || true; \
        rm -rf ../../data/certs/certificates ../../data/certs/accounts services/unrealircd/config/tls; \
        echo "SSL certificates removed."; \
    else \
        echo "SSL cleanup cancelled."; \
    fi

# Generate IRC operator password
[group('Utilities')]
generate-password:
    @echo "Generating IRC Operator Password"
    @./services/unrealircd/scripts/generate-oper-password.sh

# Linting
[group('Maintenance')]
lint:
    @echo "Linting Scripts"
    @if command -v shellcheck >/dev/null 2>&1; then \
        echo "Running shellcheck..."; \
        shellcheck scripts/*.sh; \
        echo "Shellcheck completed!"; \
    else \
        echo "shellcheck not found. Install it for script validation."; \
    fi
    @if command -v hadolint >/dev/null 2>&1; then \
        echo "Running hadolint..."; \
        hadolint services/unrealircd/Containerfile services/atheme/Containerfile services/webpanel/Containerfile services/gamja/Containerfile; \
        echo "Hadolint completed!"; \
    else \
        echo "hadolint not found. Install it for Containerfile validation."; \
    fi

# Clean up unused resources
[group('Maintenance')]
clean:
    @echo "Cleaning Up"
    docker compose down
    docker image prune -f
    @echo "Cleanup completed!"

# Reset everything (Destructive)
[group('Maintenance')]
reset:
    @echo "WARNING: This will DELETE all data!"
    @echo "This includes: containers, images, volumes, and data directories"
    @read -p "Are you sure you want to continue? (type 'yes' to confirm): " confirm && \
    if [[ "$confirm" == "yes" ]]; then \
        echo "Stopping services..."; \
        docker compose down -v; \
        echo "Removing images..."; \
        docker image prune -f; \
        echo "Removing data directories..."; \
        rm -rf data/ logs/; \
        echo "Complete reset done."; \
    else \
        echo "Reset cancelled."; \
    fi

# Show system information
[group('Utilities')]
info:
    @echo "System Information"
    @echo "Docker version:"
    docker --version
    @echo ""
    @echo "Docker Compose version:"
    docker compose --version
    @echo ""
    @echo "Available disk space:"
    df -h . | tail -1
    @echo ""
    @echo "Memory usage:"
    free -h
