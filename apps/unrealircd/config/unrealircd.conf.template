/* ============================================================================
 * UNREALIRCD CONFIGURATION - Consolidated (UnrealIRCd 6.2.0.1)
 * ============================================================================
 * All modules and RPC config inlined here. On upgrade: diff against the new
 * release's modules.default.conf and modules.optional.conf to pick up changes.
 * Docs: https://www.unrealircd.org/docs/Configuration
 * ============================================================================ */

/* ---------- Core user commands ---------- */
loadmodule "admin";
loadmodule "away";
loadmodule "invite";
loadmodule "ison";
loadmodule "join";
loadmodule "kick";
loadmodule "links";
loadmodule "list";
loadmodule "lusers";
loadmodule "map";
loadmodule "message";
loadmodule "mode";
loadmodule "motd";
loadmodule "names";
loadmodule "nick";
loadmodule "part";
loadmodule "pass";
loadmodule "pingpong";
loadmodule "protoctl";
loadmodule "quit";
loadmodule "rules";
loadmodule "topic";
loadmodule "user";
loadmodule "userhost";
loadmodule "watch";
loadmodule "whox";
loadmodule "whois";
loadmodule "whowas";

/* ---------- Additional client features ---------- */
loadmodule "botmotd";
loadmodule "cap";
loadmodule "cycle";
loadmodule "dccallow";
loadmodule "help";
loadmodule "knock";
loadmodule "lag";
loadmodule "sasl";
loadmodule "setname";
loadmodule "silence";
loadmodule "starttls";
loadmodule "time";
loadmodule "userip";
loadmodule "vhost";
loadmodule "history";

/* ---------- IRCOp commands ---------- */
loadmodule "addmotd";
loadmodule "addomotd";
loadmodule "chghost";
loadmodule "chgident";
loadmodule "chgname";
loadmodule "close";
loadmodule "connect";
loadmodule "squit";
loadmodule "dccdeny";
loadmodule "globops";
loadmodule "kill";
loadmodule "locops";
loadmodule "mkpasswd";
loadmodule "oper";
loadmodule "operinfo";
loadmodule "opermotd";
loadmodule "sajoin";
loadmodule "samode";
loadmodule "sapart";
loadmodule "sdesc";
loadmodule "sethost";
loadmodule "setident";
loadmodule "stats";
loadmodule "tkl";
loadmodule "tline";
loadmodule "trace";
loadmodule "tsctl";
loadmodule "unsqline";
loadmodule "jumpserver";

/* ---------- Server-to-server protocol ---------- */
loadmodule "eos";
loadmodule "md";
loadmodule "netinfo";
loadmodule "server";
loadmodule "sjoin";
loadmodule "sqline";
loadmodule "swhois";
loadmodule "umode2";
loadmodule "sinfo";
loadmodule "require-module";
loadmodule "slog";
loadmodule "creationtime";
loadmodule "sreply";
loadmodule "unreal_server_compat";
loadmodule "sendsno";
loadmodule "sendumode";

/* ---------- Services protocol (SVS* commands) ---------- */
loadmodule "svsjoin";
loadmodule "svskill";
loadmodule "svslusers";
loadmodule "svsmode";
loadmodule "svsmotd";
loadmodule "svsnick";
loadmodule "svsnline";
loadmodule "svsnolag";
loadmodule "svsnoop";
loadmodule "svspart";
loadmodule "svssilence";
loadmodule "svssno";
loadmodule "svswatch";
loadmodule "svso";
loadmodule "svslogin";

/* ---------- Channel modes ---------- */
loadmodule "chanmodes/chanowner";
loadmodule "chanmodes/chanadmin";
loadmodule "chanmodes/chanop";
loadmodule "chanmodes/halfop";
loadmodule "chanmodes/voice";
loadmodule "chanmodes/key";
loadmodule "chanmodes/limit";
loadmodule "chanmodes/inviteonly";
loadmodule "chanmodes/secret";
loadmodule "chanmodes/private";
loadmodule "chanmodes/moderated";
loadmodule "chanmodes/noexternalmsgs";
loadmodule "chanmodes/topiclimit";
loadmodule "chanmodes/floodprot";
loadmodule "chanmodes/nocolor";
loadmodule "chanmodes/noctcp";
loadmodule "chanmodes/stripcolor";
loadmodule "chanmodes/isregistered";
loadmodule "chanmodes/issecure";
loadmodule "chanmodes/permanent";
loadmodule "chanmodes/link";
loadmodule "chanmodes/censor";
loadmodule "chanmodes/delayjoin";
loadmodule "chanmodes/noknock";
loadmodule "chanmodes/noinvite";
loadmodule "chanmodes/operonly";
loadmodule "chanmodes/nonotice";
loadmodule "chanmodes/regonly";
loadmodule "chanmodes/nonickchange";
loadmodule "chanmodes/nokick";
loadmodule "chanmodes/regonlyspeak";
loadmodule "chanmodes/secureonly";
loadmodule "chanmodes/history";

/* ---------- User modes ---------- */
loadmodule "usermodes/wallops";
loadmodule "usermodes/bot";
loadmodule "usermodes/servicebot";
loadmodule "usermodes/noctcp";
loadmodule "usermodes/censor";
loadmodule "usermodes/showwhois";
loadmodule "usermodes/privacy";
loadmodule "usermodes/nokick";
loadmodule "usermodes/regonlymsg";
loadmodule "usermodes/secureonlymsg";
loadmodule "usermodes/privdeaf";

/* ---------- Extended bans ---------- */
loadmodule "extbans/join";
loadmodule "extbans/quiet";
loadmodule "extbans/nickchange";
loadmodule "extbans/realname";
loadmodule "extbans/account";
loadmodule "extbans/inchannel";
loadmodule "extbans/operclass";
loadmodule "extbans/certfp";
loadmodule "extbans/textban";
loadmodule "extbans/timedban";
loadmodule "extbans/partmsg";
loadmodule "extbans/securitygroup";
loadmodule "extbans/country";
loadmodule "extbans/msgbypass";
loadmodule "extbans/flood";
loadmodule "extbans/asn";
loadmodule "extbans/inherit";

/* ---------- IRCv3 capabilities & message tags ---------- */
loadmodule "account-notify";
loadmodule "message-tags";
loadmodule "batch";
loadmodule "server-time";
loadmodule "message-ids";
loadmodule "account-tag";
loadmodule "echo-message";
loadmodule "labeled-response";
loadmodule "bot-tag";
loadmodule "typing-indicator";
loadmodule "channel-context";
loadmodule "reply-tag";
loadmodule "clienttagdeny";

/* ---------- Security & TLS policy ---------- */
loadmodule "sts";
loadmodule "link-security";
loadmodule "plaintext-policy";
loadmodule "chathistory";
loadmodule "monitor";
loadmodule "extended-monitor";
loadmodule "standard-replies";
loadmodule "no-implicit-names";

/* ---------- JSON-RPC (remote management) ---------- */
loadmodule "rpc/rpc";
loadmodule "rpc/stats";
loadmodule "rpc/user";
loadmodule "rpc/server";
loadmodule "rpc/channel";
loadmodule "rpc/server_ban";
loadmodule "rpc/server_ban_exception";
loadmodule "rpc/name_ban";
loadmodule "rpc/spamfilter";
loadmodule "rpc/log";
loadmodule "rpc/whowas";

/* ---------- Security & anti-abuse ---------- */
loadmodule "ident_lookup";
loadmodule "certfp";
loadmodule "tls_cipher";
loadmodule "tls_antidos";
loadmodule "connect-flood";
loadmodule "max-unknown-connections-per-ip";
loadmodule "webirc";
loadmodule "blacklist";
loadmodule "jointhrottle";
loadmodule "charsys";
loadmodule "authprompt";
loadmodule "history_backend_mem";
loadmodule "tkldb";
loadmodule "channeldb";
loadmodule "rmtkl";
loadmodule "restrict-commands";
loadmodule "reputation";
loadmodule "connthrottle";
loadmodule "userip-tag";
loadmodule "userhost-tag";
loadmodule "geoip-tag";
loadmodule "json-log-tag";
loadmodule "issued-by-tag";
loadmodule "real-quit-reason";
loadmodule "targetfloodprot";
loadmodule "watch-backend";
loadmodule "geoip_base";
loadmodule "websocket_common";
loadmodule "spamreport";
loadmodule "crule";
loadmodule "maxperip";
loadmodule "utf8functions";

/* ---------- GeoIP (classic MaxMind database, auto-refreshed) ---------- */
loadmodule "geoip_classic";
@if module-loaded("geoip_classic")
set {
	geoip-classic {
		ipv4-database "https://www.unrealircd.org/files/geo/classic/GeoIP.dat" { url-refresh 14d; url-fail warn; }
		ipv6-database "https://www.unrealircd.org/files/geo/classic/GeoIPv6.dat" { url-refresh 14d; url-fail warn; }
		asn-ipv4-database "https://www.unrealircd.org/files/geo/classic/GeoIPASNum.dat" { url-refresh 14d; url-fail warn; }
		asn-ipv6-database "https://www.unrealircd.org/files/geo/classic/GeoIPASNumv6.dat" { url-refresh 14d; url-fail warn; }
	}
}
@endif

/* ---------- Optional modules ---------- */
loadmodule "ircops";
loadmodule "staff";
@if module-loaded("staff")
set { staff-file "network.staff"; }
@endif
loadmodule "nocodes";

/* antirandom: blocks connections with random-looking nick/ident/realname (bot detection).
 * Thresholds are tuned conservatively; trusted IPs (Docker network) are exempt. */
loadmodule "antirandom";
@if module-loaded("antirandom")
set {
	antirandom {
		threshold 6;
		ban-action kill;
		ban-time 4h;
		ban-reason "You look like a bot. Be sure to fill in your nick/ident/realname properly.";
		convert-to-lowercase yes;
		show-failedconnects yes;
		except {
			webirc yes;
			ip { 192.168.*; 127.*; 172.16.0.0/12; }
		}
	}
}
@endif

loadmodule "webserver";
loadmodule "websocket";

/* antimixedutf8: blocks messages mixing scripts (e.g. Latin+Cyrillic) used for spam/homoglyph attacks */
loadmodule "antimixedutf8";
@if module-loaded("antimixedutf8")
set {
	antimixedutf8 {
		score 8;
		ban-action block;
		ban-reason "Mixed character spam";
		ban-time 4h;
	}
}
@endif

/* ---------- RPC Unix socket (for local management tools) ---------- */
listen {
	file "/home/unrealircd/unrealircd/data/rpc.socket";
	mode 0770;
	options { rpc; }
}

/* In-memory log buffer (accessible via JSON-RPC; excludes verbose join/part/kick events) */
log {
	source {
		all;
		!debug;
		!join.LOCAL_CLIENT_JOIN;
		!join.REMOTE_CLIENT_JOIN;
		!part.LOCAL_CLIENT_PART;
		!part.REMOTE_CLIENT_PART;
		!kick.LOCAL_CLIENT_KICK;
		!kick.REMOTE_CLIENT_KICK;
	}
	destination {
		memory {
			max-lines 1000;
			max-time 7d;
		}
	}
}

/* ---------- RPC permission classes ---------- */
rpc-class full {
	permissions { all; }
}

rpc-class read-only {
	permissions {
		rpc;
		stats;
		log;
		user { list; get; }
		whowas { get; }
		server { list; get; }
		channel { list; get; }
		server_ban { list; get; }
		server_ban_exception { list; get; }
		spamfilter { list; get; }
		name_ban { list; get; }
	}
}

include "help/help.conf";
include "badwords.conf";
include "spamfilter.conf";
include "dccallow.conf";
include "operclass.default.conf";
include "snomasks.default.conf";

/* ---------- Third-party / custom modules ---------- */
loadmodule "cloak_sha256";
loadmodule "third/showwebirc";
loadmodule "third/metadata";
loadmodule "third/react";         /* IRCv3 draft/react: message reactions */
loadmodule "third/redact";        /* IRCv3 draft/message-redaction: REDACT for deletion */
loadmodule "third/relaymsg-atl";  /* atl.chat fork: RELAYMSG for stateless bridging */

/* METADATA: avatars, message coloring, status texts (draft/metadata, draft/metadata-notify-2)
 * Usage: /metadata * set avatar :https://example.com/avatar.png
 * Optional config - defaults used if omitted. */
metadata {
	max-user-metadata 10;
	max-channel-metadata 10;
	max-subscriptions 10;
}

/* RELAYMSG: stateless bridging - hostmask shown for relayed messages.
 * Default: require-separator yes (nicks must contain /). Bridge uses /d suffix (irc_relaymsg_clean_nicks: false).
 * For clean nicks (no /): add "require-separator no;" and set irc_relaymsg_clean_nicks: true in bridge config. */
relaymsg {
	hostmask "bridge@${IRC_DOMAIN}";
	require-separator no;
}

me {
	name "${IRC_DOMAIN}";
	info "${IRC_NETWORK_NAME} IRC Server";
	sid "001";
}

/* Proxy blocks - pass real client IPs to UnrealIRCd from web gateways and reverse proxies.
 * Docs: https://www.unrealircd.org/docs/Proxy_block */

/* NPM/gateway WEBIRC: passes real client IP via WEBIRC protocol.
 * Used by web gateways (KiwiIRC, The Lounge, etc.) connecting through NPM. */
proxy npm-webirc {
	type webirc;
	match { ip ${ATL_GATEWAY_IP}/32; }
	password "${ATL_WEBIRC_PASSWORD}";
}

/* NPM WebSocket reverse proxy: trust X-Forwarded-For headers from NPM/Tailscale.
 * When NPM proxies WebSocket connections (port 8000), it sends X-Forwarded-For
 * with the real client IP. Hosts matching this are auto-exempted from connect
 * floods and blacklist checks (UnrealIRCd 6.1.8+).
 *
 * NOTE: This does NOT help with raw TCP streams (port 6697). Direct IRC TLS
 * clients through NPM TCP streams will appear as the proxy IP — UnrealIRCd
 * does not support the HAProxy PROXY protocol. */
proxy npm-x-forwarded {
	type x-forwarded;
	match { ip ${ATL_GATEWAY_IP}/32; ip 100.64.0.0/10; }
}

/* The Lounge web IRC client: passes real user IP via WEBIRC.
 * Connects from the Docker network. */
proxy thelounge {
	type webirc;
	match { ip 172.16.0.0/12; }
	password "${THELOUNGE_WEBIRC_PASSWORD}";
}

admin {
	"${IRC_ADMIN_NAME}";
	"admin";
	"${IRC_ADMIN_EMAIL}";
}

class clients {
	pingfreq 90;
	maxclients 1000;
	sendq 200k;
	recvq 8000;
}

class opers {
	pingfreq 90;
	maxclients 50;
	sendq 1M;
	recvq 8000;
}

class servers {
	pingfreq 90;
	maxclients 10;
	sendq 5M;
	recvq 8000;
}

/* Unix socket for Atheme services — shares network namespace with IRC server
 * (atl-irc-services uses network_mode: service:atl-irc-server).
 * Atheme connects here via 127.0.0.1 port 6901 as configured in atheme.conf. */
listen {
	file "/home/unrealircd/unrealircd/data/services.sock";
	mode 0770;
}

/* Standard IRC over TLS — primary client connection port */
listen {
	ip *;
	port 6697;
	options { tls; }
}

/* Server-to-server over TLS — used for linking remote IRC servers */
listen {
	ip *;
	port 6900;
	options { tls; serversonly; }
}

/* Server-to-server plaintext — used by Atheme services (localhost only via shared network namespace) */
listen {
	ip *;
	port 6901;
	options { serversonly; }
}

/* JSON-RPC over TLS — for webpanel and management tools */
listen {
	ip *;
	port 8600;
	options { rpc; tls; }
	tls-options {
		certificate "/home/unrealircd/unrealircd/certs/live/${IRC_DOMAIN}/fullchain.pem";
		key "/home/unrealircd/unrealircd/certs/live/${IRC_DOMAIN}/privkey.pem";
	}
}

/* WebSocket port — TLS terminated at NPM; UnrealIRCd receives plaintext WebSocket */
listen {
	ip *;
	port 8000;
	options {
		/* tls; */ /* Disabled: SSL is terminated at NPM */
		websocket { type text; }
	}
	/* tls-options {
		certificate "/home/unrealircd/unrealircd/certs/live/${IRC_DOMAIN}/fullchain.pem";
		key "/home/unrealircd/unrealircd/certs/live/${IRC_DOMAIN}/privkey.pem";
		options {
			no-client-certificate;
		}
	} */
}

set {
	tls {
		/* Certificate configuration - data/certs mounted at certs/, live/<domain>/ layout */
		certificate "/home/unrealircd/unrealircd/certs/live/${IRC_DOMAIN}/fullchain.pem";
		key "/home/unrealircd/unrealircd/certs/live/${IRC_DOMAIN}/privkey.pem";
		/* CA certificate bundle for certificate validation */
		trusted-ca-file "/home/unrealircd/unrealircd/config/tls/curl-ca-bundle.crt";

		/* TLS 1.2 and 1.3 only — matches UnrealIRCd 6.1.9+ defaults */
		protocols "TLSv1.2,+TLSv1.3";

		/* TLS 1.2 cipher suites — ECDHE only (forward secrecy; matches UnrealIRCd 6.1.9+ defaults) */
		ciphers "ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256";

		/* TLS 1.3 cipher suites (matches UnrealIRCd 6.1.9+ defaults) */
		ciphersuites "TLS_CHACHA20_POLY1305_SHA256:TLS_AES_256_GCM_SHA384:TLS_AES_128_GCM_SHA256:TLS_AES_128_CCM_8_SHA256:TLS_AES_128_CCM_SHA256";

		/* Key exchange groups — includes post-quantum hybrid X25519MLKEM768 (UnrealIRCd 6.2.0+).
		 * X25519MLKEM768 requires OpenSSL 3.5.0+; falls back gracefully on older builds.
		 * Docs: https://www.unrealircd.org/docs/TLS_Ciphers_and_protocols */
		groups "X25519MLKEM768:X25519:secp521r1:secp384r1:prime256v1";
		/* Legacy fallback for OpenSSL builds that don't support the 'groups' directive */
		ecdh-curves "X25519:secp521r1:secp384r1:prime256v1";

		options {
			no-client-certificate;
		}

		/* Strict Transport Security (STS) — redirects clients to TLS automatically.
		 * Clients cache this for 'duration' time; start low and increase gradually:
		 *   1m -> 1d -> 30d -> 180d
		 * WARNING: Cached by clients for the full duration period. */
		sts-policy {
			port 6697;
			duration ${IRC_STS_DURATION};
			preload ${IRC_STS_PRELOAD};
		}

		certificate-expiry-notification yes;
	}

	/* Plaintext policy — control who can use non-TLS connections.
	 * Docs: https://www.unrealircd.org/docs/Set_block#set::plaintext-policy */
	plaintext-policy {
		/* Allow localhost server connections (Atheme) — localhost is exempt from link security */
		server allow;
		/* Allow users for now; STS will redirect TLS-capable clients automatically */
		user allow;
		/* IRCOps must always use TLS */
		oper deny;
		user-message "For security, please connect using TLS on port 6697. Your client will be automatically redirected if it supports STS.";
		oper-message "IRCOps must use TLS connections. Please connect to port 6697 with SSL/TLS enabled.";
	}

	/* Outdated TLS policy — warn or block connections using old TLS protocols/ciphers */
	outdated-tls-policy {
		user warn;
		oper deny;
		server deny;
		user-message "Your IRC client is using an outdated TLS protocol or cipher. Please update your IRC client for better security.";
		oper-message "IRCOps must use modern TLS. Please update your IRC client.";
	}
}

/* Link block for Atheme services — restricted to Docker network and localhost */
link ${IRC_SERVICES_SERVER} {
	incoming {
		mask 172.16.0.0/12;
		mask 127.0.0.0/8;
		password "${IRC_SERVICES_PASSWORD}";
	}
	password "${IRC_SERVICES_PASSWORD}";
	class servers;
}

/* U-lines give services special privileges (mode enforcement, nick protection, etc.) */
ulines {
	${IRC_SERVICES_SERVER};
}

/* Allow configuration — who can connect */
allow {
	mask *@*;
	class clients;
	maxperip 5;
}

/* Authentication Requirements — uncomment and customize as needed.
 * Docs: https://www.unrealircd.org/docs/Require_authentication_block */

/* Example 1: Require authentication for users from specific ISPs/countries
require authentication {
	mask *@*.suspicious-isp.com;
	reason "Many troublemakers from this provider. Please authenticate with your registered account.";
};
*/

/* Example 2: Require authentication for everyone (closed server)
require authentication {
	mask *@*;
	reason "This server requires authentication. Please register an account first.";
};
*/

/* Example 3: Require authentication for all except trusted countries
require authentication {
	mask {
		mask *;
		exclude-country { US; CA; GB; DE; FR; AU; }
	}
	reason "Authentication required from your location. Please register an account.";
};
*/

/* Ban nicknames reserved for services or system use */
ban nick {
	mask "*ChanServ*";
	reason "Reserved for Services";
}

ban nick {
	mask "*NickServ*";
	reason "Reserved for Services";
}

ban nick {
	mask "*MemoServ*";
	reason "Reserved for Services";
}

ban nick {
	mask "*BotServ*";
	reason "Reserved for Services";
}

ban nick {
	mask "*OperServ*";
	reason "Reserved for Services";
}

ban nick {
	mask "*HostServ*";
	reason "Reserved for Services";
}

ban nick {
	mask "*HelpServ*";
	reason "Reserved for Services";
}

ban nick {
	mask "*StatServ*";
	reason "Reserved for Services";
}

ban nick {
	mask "*Global*";
	reason "Reserved for Services";
}

ban nick {
	mask "*root*";
	reason "Reserved system name";
}

ban nick {
	mask "*admin*";
	reason "Reserved system name";
}

ban nick {
	mask "*administrator*";
	reason "Reserved system name";
}

ban nick {
	mask "*server*";
	reason "Reserved system name";
}

ban nick {
	mask "*services*";
	reason "Reserved for Services";
}

ban nick {
	mask "*IRC*";
	reason "Reserved for network";
}

ban nick {
	mask "*ircop*";
	reason "Reserved for operators";
}

ban nick {
	mask "*operator*";
	reason "Reserved for operators";
}

ban nick {
	mask "*guest*";
	reason "Generic guest name not allowed";
}

ban nick {
	mask "*anonymous*";
	reason "Anonymous connections not allowed";
}

ban nick {
	mask "*unknown*";
	reason "Unknown user not allowed";
}

/* DNSBL blacklists — block known proxies, drones, and TOR exit nodes.
 * Docs: https://www.unrealircd.org/docs/Blacklist_block */
blacklist dronebl {
	dns {
		name dnsbl.dronebl.org;
		type record;
		reply { 3; 5; 6; 7; 8; 9; 10; 11; 12; 13; 14; 15; 16; }
	}
	action gline;
	ban-time 24h;
	reason "Proxy/Drone detected. Check https://dronebl.org/lookup?ip=$ip for details.";
}

blacklist efnetrbl {
	dns {
		name rbl.efnetrbl.org;
		type record;
		reply { 1; 4; 5; }
	}
	action gline;
	ban-time 24h;
	reason "Proxy/Drone/TOR detected. Check https://rbl.efnetrbl.org/?i=$ip for details.";
}

blacklist tornevall {
	dns {
		name dnsbl.tornevall.org;
		type record;
		reply { 1; 2; 3; 4; 5; 6; 7; 8; 9; 10; 11; 12; 13; 14; 15; 16; }
	}
	action gline;
	ban-time 24h;
	reason "Open proxy/relay detected. Check https://dnsbl.tornevall.org/ for details.";
}

/* Exempt internal Docker network from bans/blacklists.
 * Covers bridge, services, and other containers on the atl-chat network.
 * 172.16.0.0/12 spans all default Docker bridge subnets (172.16–31.*). */
except ban {
	mask *@172.16.0.0/12;
	type { blacklist; connect-flood; maxperip; handshake-data-flood; }
}

/* Network configuration */
set {
	network-name 		"${IRC_NETWORK_NAME}";
	default-server 		"${IRC_DOMAIN}";
	services-server 	"${IRC_SERVICES_SERVER}";
	stats-server 		"${IRC_DOMAIN}";
	sasl-server 		"${IRC_SERVICES_SERVER}";

	help-channel 		"#support";
	prefix-quit 		"quit";

	/* Cloak keys — from .env; generate new keys with: just irc gencloak */
	cloak-keys {
		"${IRC_CLOAK_KEY_1}";
		"${IRC_CLOAK_KEY_2}";
		"${IRC_CLOAK_KEY_3}";
	}

	/* Hidden host prefix — must match cloak-prefix on all servers in the network */
	hiddenhost-prefix "${IRC_CLOAK_PREFIX}";

	/* Cloak method: "ip" hashes the full IP address for better privacy */
	cloak-method ip;
}

/* Die/Restart password: protects /DIE and /RESTART from accidental or unauthorized use */
drpass {
	restart "${IRC_DRPASS}";
	die "${IRC_DRPASS}";
}

/* Staff oper block — network staff with full privileges and vhost */
oper staff {
	class opers;
	mask *;
	password "${IRC_OPER_PASSWORD}";
	operclass netadmin-with-override;
	swhois "is a member of the Network Staff";
	vhost "${DOLLAR}account@${IRC_STAFF_VHOST}";
	require-modes "z";
}

/* Bridge operclass — minimal privileges needed for the bridge bot:
 * - channel override: allows setting +P (permanent) without being chanop
 * - relaymsg: allows RELAYMSG for stateless bridging (third/relaymsg-atl) */
operclass bridge-oper {
	parent locop;
	permissions {
		channel { operonly; override; }
		relaymsg;
	}
}

oper bridge {
	class opers;
	mask *@*bridge*;
	password "${BRIDGE_IRC_OPER_PASSWORD}";
	operclass bridge-oper;
	vhost "bridge@bridge.atl.chat";
}

/* RPC user for webpanel — restricted to Docker network and localhost */
rpc-user "${WEBPANEL_RPC_USER}" {
	match { ip 172.16.0.0/12; ip 127.0.0.0/8; }
	rpc-class full;
	password "${WEBPANEL_RPC_PASSWORD}";
}

/* Automatic vhost for registered users — applied at login via services */
vhost {
	auto-login yes;
	mask {
		identified yes;
	}
	vhost "${DOLLAR}account@${IRC_ROOT_DOMAIN}";
}

/* Log to stdout (JSON) — captured by Docker json-file driver with rotation.
 * No file-based logging; use `docker compose logs atl-irc-server` to read.
 * Verbose join/part/kick events excluded to reduce noise. */
log {
	source {
		all;
		!debug;
		!join.LOCAL_CLIENT_JOIN;
		!join.REMOTE_CLIENT_JOIN;
		!part.LOCAL_CLIENT_PART;
		!part.REMOTE_CLIENT_PART;
		!kick.LOCAL_CLIENT_KICK;
		!kick.REMOTE_CLIENT_KICK;
	}
	destination {
		file "/dev/stdout" { type json; }
	}
}

set {
	kline-address '${IRC_ADMIN_EMAIL}'; /* e-mail or URL shown when a user is banned */
	gline-address '${IRC_ADMIN_EMAIL}'; /* e-mail shown on G-lines */

	modes-on-connect "+ixw"; /* user modes set automatically on connect */
	modes-on-oper "+xwsH"; /* additional modes set when someone becomes IRCOp */
	snomask-on-oper "+bBcdfkqsSo"; /* server notice mask for opers */
	modes-on-join "+nt"; /* default channel modes for newly created channels */

	/* Prevent users from disabling their cloak (+x) for privacy */
	restrict-usermodes "x";

	/* Control WHOIS visibility of webirc/websocket metadata */
	whois-details {
		webirc { everyone none; self full; oper full; };
		websocket { everyone none; self full; oper full; };
	}
	oper-auto-join "#mod-chat"; /* IRCOps are auto-joined to this channel on oper-up */
	options {
		hide-ulines; /* hide U-lines in /MAP and /LINKS */
		show-connect-info; /* show "looking up your hostname" messages on connect */
	}

	/* Authentication prompt enabled by default via the authprompt module */

	maxchannelsperuser 10; /* maximum number of channels a user may /JOIN */

	/* Restrict /STATS to safe statistics for regular users; everything else is oper-only */
	allow-user-stats "kMp";

	/* Spamfilter global defaults */
	spamfilter {
		ban-time 1d;
		ban-reason "Spam/Advertising";
		virus-help-channel "#help";
	}

	/* Connection throttling: limits new connections during attacks.
	 * Exempts identified users and those with established reputation.
	 * Docs: https://www.unrealircd.org/docs/Connthrottle */
	connthrottle {
		except { reputation-score 24; identified yes; }
		new-users {
			local-throttle 20:60;
			global-throttle 30:60;
		}
		disabled-when {
			reputation-gathering 1w;
			start-delay 3m;
		}
	}

	anti-spam-quit-message-time 10s;

	history {
		channel {
			/* Use defaults — 200 lines max, 31 days retention */
		}
	};

	/* restrict-commands: delay certain commands for new/untrusted users.
	 * Identified users and those with reputation score ≥24 are exempt.
	 * Docs: https://www.unrealircd.org/docs/Set_block#set::restrict-commands */
	restrict-commands {
		list {
			except { identified yes; reputation-score 24; }
			connect-delay 60s;
		}
		invite {
			except { identified yes; reputation-score 24; }
			connect-delay 120s;
		}
		private-message {
			except { identified yes; webirc yes; reputation-score 24; }
			connect-delay 120s;
		}
		private-notice {
			except { identified yes; webirc yes; reputation-score 24; }
			connect-delay 120s;
		}
	}

	/* Anti-flood settings — controls flood protection for channels and users.
	 * 'known-users' = identified to services OR IP connected for >2h in past X days.
	 * 'unknown-users' = everyone else (stricter limits).
	 * Docs: https://www.unrealircd.org/docs/Anti-flood_settings */
	anti-flood {
		/* Channel flood profiles — used with channel mode +F.
		 * Format: [c#C<cooldown>,j#R<rejoin>,k#K<kick>,m#M<msg>,n#N<nick>]:<seconds> */
		channel {
			default-profile normal;

			profile very-strict { flood-mode "[7c#C15,10j#R10,10k#K15,30m#M10,10n#N15]:15"; }
			profile strict      { flood-mode "[7c#C15,15j#R10,10k#K15,40m#M10,10n#N15]:15"; }
			profile normal      { flood-mode "[7c#C15,30j#R10,10k#K15,40m#M10,10n#N15]:15"; }
			profile relaxed     { flood-mode "[7c#C15,45j#R10,10k#K15,60m#M10,10n#N15]:15"; }
			profile very-relaxed { flood-mode "[7c#C15,60j#R10,10k#K15,90m#M10,10n#N15]:15"; }
		}

		/* Settings that apply to all users regardless of group */
		everyone {
			connect-flood 5:60; /* max 5 connection attempts per IP per 60 seconds */

			/* Handshake data flood — blocks clients sending >4k during IRC handshake */
			handshake-data-flood {
				amount 4k;
				ban-action zline;
				ban-time 10m;
			}

			/* Target flood — limits total message rate to a channel/user.
			 * This is NOT per-sender; it limits the aggregate rate to the target.
			 * Drop (not kill) is used because innocent users may send the Nth message. */
			target-flood {
				channel-privmsg 45:5;
				channel-notice 15:5;
				channel-tagmsg 15:5;
				private-privmsg 30:5;
				private-notice 10:5;
				private-tagmsg 10:5;
			}
		}

		/* Known users (identified/trusted) — higher limits and lower lag penalties */
		known-users {
			nick-flood 4:60;
			join-flood 4:90;
			away-flood 4:120;
			invite-flood 5:60;
			knock-flood 4:120;
			vhost-flood 3:90;
			max-concurrent-conversations {
				users 12;           /* can message 12 different users before rate limiting */
				new-user-every 10s; /* then 1 new conversation target every 10 seconds */
			}
			lag-penalty 600;        /* fake lag per command (ms); lower = more permissive */
			lag-penalty-bytes 200;  /* bytes before extra lag penalty; higher = more permissive */
		}

		/* Unknown users (new/untrusted) — stricter limits */
		unknown-users {
			nick-flood 2:60;
			join-flood 2:90;
			away-flood 3:120;
			invite-flood 2:60;
			knock-flood 2:120;
			vhost-flood 2:90;
			max-concurrent-conversations {
				users 4;            /* can message 4 different users before rate limiting */
				new-user-every 20s; /* then 1 new conversation target every 20 seconds */
			}
			lag-penalty 1200;       /* higher fake lag penalty for unknown users */
			lag-penalty-bytes 80;   /* stricter byte threshold before extra lag penalty */
		}
	}
}
